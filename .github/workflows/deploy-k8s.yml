name: Deploy to Kubernetes

on:
  workflow_call:
    inputs:
      service-name:
        description: 'Service name in GitOps repo'
        type: string
        required: true
      environment:
        description: 'Deployment environment'
        type: string
        required: true
      image-tag:
        description: 'Docker image tag to deploy'
        type: string
        required: true
      image-url:
        description: 'Full Docker image URL'
        type: string
        required: true
      gitops-repo:
        description: 'GitOps repository'
        type: string
        required: false
        default: 'karmadev/gitops'
      version:
        description: 'Version number for deployment summary'
        type: string
        required: false
    secrets:
      GITOPS_TOKEN:
        description: 'GitHub token for GitOps repo'
        required: true
      SLACK_WEBHOOK_URL:
        description: 'Slack webhook URL for notifications'
        required: false

jobs:
  deploy:
    name: Deploy to ${{ inputs.environment }}
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.environment }}
    steps:
      - name: Checkout GitOps repository
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.gitops-repo }}
          token: ${{ secrets.GITOPS_TOKEN }}
          ref: master
          path: gitops
      
      - name: Checkout source repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITOPS_TOKEN }}
          path: source
      
      - name: Build and deploy Kubernetes manifests (like old Buildkite)
        run: |
          ENV="${{ inputs.environment }}"
          SERVICE_NAME="${{ inputs.service-name }}"
          IMAGE_TAG="${{ inputs.image-tag }}"
          IMAGE_URL="${{ inputs.image-url }}"
          
          echo "Building Kubernetes manifests from source repo..."
          
          # Check if source has kubernetes configs
          if [ -d "source/kubernetes/overlays/$ENV" ]; then
            echo "Found kubernetes configs in source/kubernetes/overlays/$ENV"
            
            # Create service directory in GitOps if it doesn't exist
            mkdir -p "gitops/$SERVICE_NAME/$ENV"
            
            # Build manifests using kubectl kustomize (like old Buildkite did)
            cd source/kubernetes/overlays/$ENV
            
            # First update image tag in kustomization before building
            if [ -f "kustomization.yaml" ]; then
              # Use kustomize edit to update image
              if kubectl kustomize . | grep -q "$SERVICE_NAME"; then
                echo "Updating image tag in kustomization..."
                # Create temporary kustomization with updated image
                cp kustomization.yaml kustomization.yaml.backup
                
                # Update image tag - handle both old and new image name formats
                if grep -q "newTag:" kustomization.yaml; then
                  sed -i.bak "s/newTag:.*/newTag: $IMAGE_TAG/" kustomization.yaml
                else
                  echo "Warning: No newTag found in kustomization.yaml"
                fi
              fi
            fi
            
            # Build the final manifest (this resolves base references in source repo)
            # This is exactly what old Buildkite did: kustomize build and put result in gitops
            echo "Building final manifest..."
            kubectl kustomize . > ../../../gitops/$SERVICE_NAME/$ENV/manifest.yaml
            
            # Update image tag in the built manifest (like Buildkite did with image replacement)
            cd ../../../gitops/$SERVICE_NAME/$ENV
            if [ -f "manifest.yaml" ]; then
              # Replace image references with new tag
              sed -i "s|image: .*${SERVICE_NAME}:.*|image: ${IMAGE_URL}|g" manifest.yaml
              sed -i "s|europe-docker.pkg.dev.*/eu.gcr.io/${SERVICE_NAME}:.*|${IMAGE_URL}|g" manifest.yaml
            fi
            
            echo "âœ“ Built and deployed pre-built manifests to GitOps (like old Buildkite)"
          else
            echo "No kubernetes configs found in source/kubernetes/overlays/$ENV, updating existing GitOps configs"
            
            cd gitops
            
            # Update existing GitOps configs with new image tag
            if [ -f "$SERVICE_NAME/$ENV/kustomization.yaml" ]; then
              cd "$SERVICE_NAME/$ENV"
              sed -i.bak "s/newTag:.*/newTag: $IMAGE_TAG/" kustomization.yaml
            fi
          fi
      
      - name: Commit and push changes
        run: |
          cd gitops
          
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          ENV="${{ inputs.environment }}"
          IMAGE_TAG="${{ inputs.image-tag }}"
          SERVICE_NAME="${{ inputs.service-name }}"
          
          git add -A
          git commit -m "Deploy ${SERVICE_NAME} to ${ENV} - ${IMAGE_TAG}
          
          Updated Kubernetes configs from source repository and image tag to ${IMAGE_TAG}
          
          ðŸ¤– Generated with [Claude Code](https://claude.ai/code)
          
          Co-Authored-By: Claude <noreply@anthropic.com>" || echo "No changes to commit"
          git push
      
      - name: Wait for ArgoCD sync
        run: |
          echo "ArgoCD will automatically sync the changes within 3 minutes"
          echo "You can manually sync in ArgoCD UI if needed for immediate deployment"
      
      - name: Deployment Summary
        run: |
          ENV="${{ inputs.environment }}"
          IMAGE_TAG="${{ inputs.image-tag }}"
          VERSION="${{ inputs.version }}"
          SERVICE_NAME="${{ inputs.service-name }}"
          
          echo "## ðŸŽ‰ Deployment Initiated Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployment Details:" >> $GITHUB_STEP_SUMMARY
          if [ -n "$VERSION" ]; then
            echo "- **Version:** \`${VERSION}\`" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- **Environment:** \`${ENV}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Service:** ${SERVICE_NAME}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Tag:** \`${IMAGE_TAG}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit SHA:** \`${GITHUB_SHA:0:8}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. ArgoCD will sync within 3 minutes" >> $GITHUB_STEP_SUMMARY
          echo "2. Check deployment status in ArgoCD" >> $GITHUB_STEP_SUMMARY
          echo "3. Verify service health after deployment" >> $GITHUB_STEP_SUMMARY
      
      - name: Send Slack Notification
        if: success()
        uses: slackapi/slack-github-action@v2.1.1
        with:
          webhook-type: incoming-webhook
          payload: |
            {
              "text": "ðŸš€ Deployment Successful",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "ðŸš€ ${{ inputs.service-name }} Deployed to ${{ inputs.environment }}",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Service:*\n${{ inputs.service-name }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Environment:*\n${{ inputs.environment }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Version:*\n${{ inputs.version || inputs.image-tag }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Deployed by:*\n${{ github.actor }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Commit:* <${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|${{ github.sha }}>\n*Workflow:* <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Details>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}