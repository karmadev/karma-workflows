name: Determine Environment

on:
  workflow_call:
    outputs:
      environment:
        description: 'The deployment environment (development/staging/production)'
        value: ${{ jobs.determine.outputs.environment }}
      should-deploy:
        description: 'Whether deployment should proceed'
        value: ${{ jobs.determine.outputs.should-deploy }}
      image-tag:
        description: 'Docker image tag to use'
        value: ${{ jobs.determine.outputs.image-tag }}
      version:
        description: 'Version number (without v prefix)'
        value: ${{ jobs.determine.outputs.version }}

jobs:
  determine:
    name: Determine Deployment Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.determine.outputs.environment }}
      should-deploy: ${{ steps.determine.outputs.should-deploy }}
      image-tag: ${{ steps.determine.outputs.image-tag }}
      version: ${{ steps.determine.outputs.version }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Determine environment from ref
        id: determine
        run: |
          # Dev build deployment (dev-20250828-1430-1)
          if [[ "$GITHUB_REF" == refs/tags/dev-* ]]; then
            TAG_NAME=${GITHUB_REF#refs/tags/}
            VERSION=${TAG_NAME#dev-}  # Remove 'dev-' prefix
            
            echo "should-deploy=true" >> $GITHUB_OUTPUT
            echo "version=${VERSION}" >> $GITHUB_OUTPUT
            echo "image-tag=${TAG_NAME}" >> $GITHUB_OUTPUT
            echo "environment=development" >> $GITHUB_OUTPUT
            echo "üîß Development deployment triggered by build tag: ${TAG_NAME}"
          # Version tag-based deployment (v1.0.0, v1.0.0-staging, etc.)
          elif [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            TAG_NAME=${GITHUB_REF#refs/tags/}
            VERSION=${TAG_NAME#v}  # Remove 'v' prefix
            
            echo "should-deploy=true" >> $GITHUB_OUTPUT
            echo "version=${VERSION}" >> $GITHUB_OUTPUT
            echo "image-tag=${TAG_NAME}" >> $GITHUB_OUTPUT
            
            # Determine environment based on version suffix
            if [[ "$TAG_NAME" == *"-staging" ]]; then
              echo "environment=staging" >> $GITHUB_OUTPUT
              echo "üé≠ Staging deployment triggered by version tag: ${TAG_NAME}"
            elif [[ "$TAG_NAME" == *"-dev" ]]; then
              echo "environment=development" >> $GITHUB_OUTPUT
              echo "üîß Development deployment triggered by version tag: ${TAG_NAME}"
            else
              echo "environment=production" >> $GITHUB_OUTPUT
              echo "üöÄ Production deployment triggered by version tag: ${TAG_NAME}"
            fi
          else
            # For branches, PRs and other events, only build (don't deploy)
            # Deployments are ONLY triggered by tags
            SHORT_SHA=$(git rev-parse --short HEAD)
            echo "image-tag=${SHORT_SHA}" >> $GITHUB_OUTPUT
            echo "should-deploy=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è Build only (no deployment) for ref: ${GITHUB_REF}"
            echo "   Use 'npm run deploy' to create a deployment tag"
          fi